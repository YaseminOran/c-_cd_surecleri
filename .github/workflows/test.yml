name: ğŸ§ª HÄ±zlÄ± Test Workflow

# TÃ¼m branch'lerde hÄ±zlÄ± testleri Ã§alÄ±ÅŸtÄ±r
on:
  push:
    branches: [ main, develop, feature/* ]
  
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸš€ HÄ±zlÄ± Testler (Feature branch'ler iÃ§in)
  quick-tests:
    name: âš¡ HÄ±zlÄ± Testler
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Minimal BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install --upgrade pip
        pip install pytest flask requests
    
    - name: ğŸ§ª Temel Testleri Ã‡alÄ±ÅŸtÄ±r
      run: |
        # Sadece kritik testleri Ã§alÄ±ÅŸtÄ±r
        python -m pytest tests/test_model.py::TestSimpleModel::test_model_predict_with_value -v
        python -m pytest tests/test_utils.py::TestInputValidation::test_validate_input_valid_data -v
    
    - name: ğŸ” Syntax Check
      run: |
        python -m py_compile src/*.py
        python -m py_compile tests/*.py

  # ğŸ“ Code Review Helper
  code-review:
    name: ğŸ“ Code Review YardÄ±mcÄ±sÄ±
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Tam history iÃ§in
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Code Analysis Tools YÃ¼kle
      run: |
        pip install flake8 black isort
    
    - name: ğŸ¨ Code Style KontrolÃ¼
      run: |
        echo "ğŸ¨ Code style kontrolleri..."
        
        # Black formatting check
        black --check --diff src/ tests/ || {
          echo "âŒ Code formatting hatasÄ± bulundu!"
          echo "ğŸ’¡ Ã‡Ã¶zÃ¼m: black src/ tests/"
          exit 1
        }
        
        # Import sorting check
        isort --check-only --diff src/ tests/ || {
          echo "âŒ Import sorting hatasÄ± bulundu!"
          echo "ğŸ’¡ Ã‡Ã¶zÃ¼m: isort src/ tests/"
          exit 1
        }
        
        echo "âœ… Code style kontrolleri baÅŸarÄ±lÄ±!"
    
    - name: ğŸ” Changed Files Analysis
      run: |
        echo "ğŸ” DeÄŸiÅŸen dosyalar analiz ediliyor..."
        
        # PR'da deÄŸiÅŸen dosyalarÄ± bul
        git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '\.(py)$' || {
          echo "â„¹ï¸ Python dosyasÄ± deÄŸiÅŸikliÄŸi yok"
          exit 0
        }
        
        # DeÄŸiÅŸen Python dosyalarÄ±nÄ± analiz et
        changed_files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '\.(py)$')
        
        echo "ğŸ“ DeÄŸiÅŸen Python dosyalarÄ±:"
        echo "$changed_files"
        
        # Her dosya iÃ§in basit metrik toplama
        for file in $changed_files; do
          if [[ -f "$file" ]]; then
            echo "ğŸ“Š $file:"
            echo "  - SatÄ±r sayÄ±sÄ±: $(wc -l < $file)"
            echo "  - Fonksiyon sayÄ±sÄ±: $(grep -c '^def ' $file || echo 0)"
            echo "  - Class sayÄ±sÄ±: $(grep -c '^class ' $file || echo 0)"
          fi
        done
    
    - name: ğŸ§ª Test Coverage Analizi (Sadece deÄŸiÅŸen dosyalar)
      run: |
        echo "ğŸ§ª DeÄŸiÅŸen dosyalar iÃ§in test coverage..."
        
        # BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
        pip install pytest pytest-cov
        pip install -r config/requirements.txt
        
        # Sadece deÄŸiÅŸen src dosyalarÄ± iÃ§in coverage
        changed_src_files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep '^src/.*\.py$' || true)
        
        if [[ -n "$changed_src_files" ]]; then
          echo "ğŸ“Š Coverage analizi yapÄ±lÄ±yor:"
          for file in $changed_src_files; do
            if [[ -f "$file" ]]; then
              module_name=$(echo $file | sed 's|src/||' | sed 's|\.py||' | sed 's|/|.|g')
              echo "  ğŸ” $module_name"
            fi
          done
          
          # Test Ã§alÄ±ÅŸtÄ±r
          python -m pytest tests/ --cov=src/ --cov-report=term-missing
        else
          echo "â„¹ï¸ Src dosyasÄ± deÄŸiÅŸikliÄŸi yok"
        fi

  # ğŸ”’ Security Scan (PR iÃ§in hafif)
  security-check:
    name: ğŸ”’ GÃ¼venlik KontrolÃ¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ›¡ï¸ Security Scan
      run: |
        # Basit security kontrolleri
        echo "ğŸ” Security kontrolleri..."
        
        # Hardcoded secrets kontrolÃ¼
        if grep -r -E '(password|secret|key|token)\s*=\s*["\'][^"\']{8,}["\']' src/ tests/ 2>/dev/null; then
          echo "âŒ Hardcoded secret bulundu!"
          echo "âš ï¸  Secrets'larÄ± environment variable olarak kullanÄ±n"
          exit 1
        fi
        
        # Dangerous imports kontrolÃ¼
        if grep -r 'import os' src/ | grep -E 'os\.(system|popen|exec)' 2>/dev/null; then
          echo "âš ï¸ Potentially dangerous os calls bulundu"
        fi
        
        echo "âœ… Security kontrolleri tamamlandÄ±"

  # ğŸ“Š PR Summary
  pr-summary:
    name: ğŸ“Š PR Ã–zeti
    runs-on: ubuntu-latest
    needs: [quick-tests, code-review, security-check]
    if: always() && github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“Š PR Durumu Ã–zeti
      run: |
        echo "ğŸ“Š Pull Request Ã–zeti"
        echo "==================="
        echo "ğŸ·ï¸ PR: ${{ github.event.pull_request.title }}"
        echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
        echo "ğŸŒ¿ Branch: ${{ github.head_ref }}"
        echo "ğŸ¯ Target: ${{ github.base_ref }}"
        echo ""
        echo "ğŸ“‹ Test SonuÃ§larÄ±:"
        echo "  âš¡ HÄ±zlÄ± Testler: ${{ needs.quick-tests.result }}"
        echo "  ğŸ“ Code Review: ${{ needs.code-review.result }}"
        echo "  ğŸ”’ Security Check: ${{ needs.security-check.result }}"
        echo ""
        
        # Genel durum
        if [[ "${{ needs.quick-tests.result }}" == "success" && \
              "${{ needs.code-review.result }}" == "success" && \
              "${{ needs.security-check.result }}" == "success" ]]; then
          echo "âœ… PR merge iÃ§in hazÄ±r!"
          echo "ğŸ’¡ Next: Full CI pipeline main branch'e merge sonrasÄ± Ã§alÄ±ÅŸacak"
        else
          echo "âŒ PR'da dÃ¼zeltilmesi gereken sorunlar var"
          echo "ğŸ”§ LÃ¼tfen failed check'leri gÃ¶zden geÃ§irin"
        fi
        
        # PR comment iÃ§in data hazÄ±rla (gerÃ§ek projede GitHub API kullanÄ±lÄ±r)
        echo "comment_body=PR Status: ${{ needs.quick-tests.result == 'success' && needs.code-review.result == 'success' && needs.security-check.result == 'success' && 'âœ… Ready for merge' || 'âŒ Needs fixes' }}" >> $GITHUB_OUTPUT

  # ğŸ¯ Branch Protection Feedback
  branch-protection:
    name: ğŸ›¡ï¸ Branch Protection
    runs-on: ubuntu-latest
    needs: [quick-tests, code-review, security-check]
    if: always()
    
    steps:
    - name: ğŸ›¡ï¸ Branch Protection Status
      run: |
        # Branch protection iÃ§in gerekli kontroller
        echo "ğŸ›¡ï¸ Branch Protection Kontrolleri"
        
        all_passed=true
        
        if [[ "${{ needs.quick-tests.result }}" != "success" ]]; then
          echo "âŒ Quick tests failed"
          all_passed=false
        fi
        
        if [[ "${{ needs.code-review.result }}" != "success" ]]; then
          echo "âŒ Code review checks failed"
          all_passed=false
        fi
        
        if [[ "${{ needs.security-check.result }}" != "success" ]]; then
          echo "âŒ Security checks failed"
          all_passed=false
        fi
        
        if [[ "$all_passed" == "true" ]]; then
          echo "âœ… TÃ¼m required checks baÅŸarÄ±lÄ± - Branch merge edilebilir"
          exit 0
        else
          echo "âŒ Branch merge edilemez - Required checks baÅŸarÄ±sÄ±z"
          exit 1
        fi