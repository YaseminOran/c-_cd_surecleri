name: ğŸ§ª SÃ¼rekli Entegrasyon (CI)

# Bu workflow ne zaman Ã§alÄ±ÅŸacak?
on:
  # Her push'ta Ã§alÄ±ÅŸ
  push:
    branches: [ main, develop, feature/* ]
  
  # Pull request'lerde Ã§alÄ±ÅŸ
  pull_request:
    branches: [ main, develop ]
  
  # Manuel olarak da Ã§alÄ±ÅŸtÄ±rÄ±labilir
  workflow_dispatch:

# Environment variables
env:
  PYTHON_VERSION: '3.11'
  
jobs:
  # 1ï¸âƒ£ Kod Kalitesi KontrolÃ¼
  code-quality:
    name: ğŸ” Kod Kalitesi
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install --upgrade pip
        pip install -r config/requirements-dev.txt
    
    - name: ğŸ¨ Code Style (Black)
      run: |
        black --check src/ tests/
    
    - name: ğŸ”§ Linting (Flake8)
      run: |
        flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503
    
    - name: ğŸ·ï¸ Type Checking (MyPy)
      run: |
        mypy src/ --ignore-missing-imports
      continue-on-error: true  # Type checking opsiyonel

  # 2ï¸âƒ£ Unit Testleri
  unit-tests:
    name: ğŸ§ª Unit Testler
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python ${{ matrix.python-version }} Kur
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install --upgrade pip
        pip install -r config/requirements-dev.txt
    
    - name: ğŸ§ª Testleri Ã‡alÄ±ÅŸtÄ±r
      run: |
        python -m pytest tests/ -v \
          --cov=src/ \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=80
    
    - name: ğŸ“Š Coverage Raporu YÃ¼kle
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # 3ï¸âƒ£ GÃ¼venlik TaramasÄ±
  security-scan:
    name: ğŸ”’ GÃ¼venlik Tarama
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Security Tools YÃ¼kle
      run: |
        pip install safety bandit
    
    - name: ğŸ›¡ï¸ Dependency Vulnerability Scan
      run: |
        safety check --json || true
    
    - name: ğŸ” Code Security Scan (Bandit)
      run: |
        bandit -r src/ -f json || true

  # 4ï¸âƒ£ Docker Build Test
  docker-build:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [unit-tests, security-scan]
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Docker Buildx Kur
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ³ Docker Image Build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: cicd-example:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ğŸ§ª Docker Image Test
      run: |
        # Container'Ä± Ã§alÄ±ÅŸtÄ±r
        docker run -d --name test-container -p 5000:5000 cicd-example:test
        
        # Container'Ä±n baÅŸlamasÄ±nÄ± bekle
        sleep 10
        
        # Health check
        curl -f http://localhost:5000/health || exit 1
        
        # Container'Ä± durdur
        docker stop test-container
        docker rm test-container

  # 5ï¸âƒ£ Performance Testleri
  performance-tests:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install --upgrade pip
        pip install -r config/requirements-dev.txt
        pip install locust
    
    - name: ğŸš€ API'yi BaÅŸlat
      run: |
        python src/app.py &
        sleep 5
    
    - name: âš¡ Load Test
      run: |
        # Basit performance testi
        python -c "
        import requests
        import time
        
        # 100 istek gÃ¶nder
        times = []
        for i in range(100):
            start = time.time()
            response = requests.get('http://localhost:5000/health')
            end = time.time()
            times.append(end - start)
            assert response.status_code == 200
        
        avg_time = sum(times) / len(times)
        print(f'Ortalama response time: {avg_time:.3f}s')
        assert avg_time < 0.1  # 100ms'den az olmalÄ±
        "

  # 6ï¸âƒ£ SonuÃ§ Bildirimi
  ci-results:
    name: ğŸ“Š CI SonuÃ§larÄ±
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, security-scan, docker-build]
    if: always()
    
    steps:
    - name: ğŸ“Š SonuÃ§larÄ± Kontrol Et
      run: |
        echo "ğŸ” Kod Kalitesi: ${{ needs.code-quality.result }}"
        echo "ğŸ§ª Unit Testler: ${{ needs.unit-tests.result }}"
        echo "ğŸ”’ GÃ¼venlik Tarama: ${{ needs.security-scan.result }}"
        echo "ğŸ³ Docker Build: ${{ needs.docker-build.result }}"
        
        if [[ "${{ needs.code-quality.result }}" == "success" && \
              "${{ needs.unit-tests.result }}" == "success" && \
              "${{ needs.security-scan.result }}" == "success" && \
              "${{ needs.docker-build.result }}" == "success" ]]; then
          echo "âœ… TÃ¼m CI kontrolleri baÅŸarÄ±lÄ±!"
          echo "ready_for_deployment=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ BazÄ± CI kontrolleri baÅŸarÄ±sÄ±z!"
          echo "ready_for_deployment=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    outputs:
      ready_for_deployment: ${{ steps.check.outputs.ready_for_deployment }}

# Workflow tamamlandÄ±ÄŸÄ±nda bildirim gÃ¶nder
  notification:
    name: ğŸ“¢ Bildirim
    runs-on: ubuntu-latest
    needs: ci-results
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¢ Slack Bildirimi
      if: always()
      run: |
        if [[ "${{ needs.ci-results.result }}" == "success" ]]; then
          echo "âœ… CI baÅŸarÄ±lÄ± - Main branch'e merge iÃ§in hazÄ±r!"
          # Burada Slack webhook kullanabilirsiniz
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"âœ… CI Pipeline baÅŸarÄ±lÄ±!"}' \
          #   $SLACK_WEBHOOK_URL
        else
          echo "âŒ CI baÅŸarÄ±sÄ±z - Deployment durduruldu!"
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"âŒ CI Pipeline baÅŸarÄ±sÄ±z!"}' \
          #   $SLACK_WEBHOOK_URL
        fi